name: CD

on:
  push:
    branches: [dev, main]
  workflow_dispatch:
    inputs:
      action:
        description: "Select action"
        required: true
        default: "promote-to-stable"
        type: choice
        options:
          - promote-to-stable

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: cd-${{ github.repository }}
  cancel-in-progress: false

jobs:
  # ═══════════════════ Manual: Promote dev -> main ═══════════════════
  promote:
    name: Promote to Stable
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'promote-to-stable'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Check CI/CD status on dev
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x .github/scripts/check-ci-cd-status.sh
          ./.github/scripts/check-ci-cd-status.sh --branch=dev

      - name: Create PR dev -> main
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          EXISTING_PR=$(gh pr list --base main --head dev --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for dev -> main"
            echo "URL: https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
            exit 0
          fi

          LATEST_TAG=$(git describe --tags --abbrev=0 origin/dev 2>/dev/null || echo "")
          if [ -z "$LATEST_TAG" ]; then
            PR_TITLE="feat: promote dev to main"
          else
            PR_TITLE="feat: promote dev to main ($LATEST_TAG)"
          fi

          gh pr create \
            --base main \
            --head dev \
            --title "$PR_TITLE" \
            --body "## Promote dev to main

          This PR promotes the latest changes from \`dev\` branch to \`main\`.

          ### Pre-checks passed:
          - CI workflow passed on dev
          - CD workflow passed on dev

          ### Latest beta version: $LATEST_TAG"

  # ═══════════════════ Release Please (beta on dev) ═══════════════════
  release-beta:
    name: Release Please (Beta)
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GH_PAT }}
          config-file: release-please-config-beta.json
          manifest-file: .release-please-manifest.json
          target-branch: dev

  # ═══════════════════ Release Please (stable on main) ═══════════════════
  release-stable:
    name: Release Please (Stable)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GH_PAT }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          target-branch: main

  # ═══════════════════ Publish to PyPI ═══════════════════
  publish-pypi:
    name: Publish to PyPI
    needs: [release-beta, release-stable]
    if: |
      always() && (
        needs.release-beta.outputs.release_created == 'true' ||
        needs.release-stable.outputs.release_created == 'true'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: uv publish

  # ═══════════════════ Sync dev from main after stable release ═══════════════════
  sync-dev:
    name: Sync Dev Branch
    needs: [release-stable]
    if: always() && needs.release-stable.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Recreate dev from main
        run: |
          git push origin --delete dev || true
          git checkout -b dev
          git push origin dev
          echo "Dev branch synced from main"
