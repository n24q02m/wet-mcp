<<<<<<< SEARCH
    mock_client.get.return_value = mock_response

    mock_client_cls = MagicMock()
    mock_client_cls.return_value.__aenter__.return_value = mock_client
    mock_client_cls.return_value.__aexit__.return_value = None

    with patch("httpx.AsyncClient", mock_client_cls):
        url = "http://localhost/secret.txt"
        with patch("pathlib.Path.mkdir"), patch("pathlib.Path.write_bytes"):
            result_json = await download_media([url], "/tmp/downloads")

        # The request was NOT made because it's unsafe
        mock_client.get.assert_not_called()
=======
    # Mock stream method
    mock_client.stream.return_value.__aenter__.return_value = mock_response
    mock_client.stream.return_value.__aexit__.return_value = None

    mock_client_cls = MagicMock()
    mock_client_cls.return_value.__aenter__.return_value = mock_client
    mock_client_cls.return_value.__aexit__.return_value = None

    with patch("httpx.AsyncClient", mock_client_cls):
        url = "http://localhost/secret.txt"
        with patch("pathlib.Path.mkdir"), patch("builtins.open"):
            result_json = await download_media([url], "/tmp/downloads")

        # The request was NOT made because it's unsafe
        mock_client.stream.assert_not_called()
>>>>>>> REPLACE
